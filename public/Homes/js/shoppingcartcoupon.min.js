ec.pkg("ec.shoppingCart.coupon");var couponBox;ec.shoppingCart.coupon={sbomCouponList:{},applyResultList:{},loadCoupon:function(){var A=[];$('input[name="prdSbomCode"]').each(function(){A.push($(this).val())});var B=A.join(",");ec.shoppingCart.coupon.loadCouponEx(B,function(C){if(C&&C.success&&C.couponList&&C.couponList.length>0){ec.shoppingCart.coupon.sbomCouponList[B]=C.couponList;$("#couponBtn").html('<a href="javascript:;" onclick="ec.shoppingCart.coupon.clickBtn(\''+B+'\')" class="whole-prompt-link" >点击领取</a>');$("#whole-prompt-coupon").show()}else{$("#whole-prompt-coupon").hide()}},function(C){},function(){})},loadCouponEx:function(C,D,B,A){$.ajax({url:domainMain+"/order/shoppingCart/queryCoupon.json",data:{sbom:C,},dataType:"json",timeout:10000,success:function(E){D(E)},error:function(E){B(E)}})},clickBtn:function(A){ec.shoppingCart.coupon.showDialog(A)},closeDialog:function(){$("#pro-roll-page").hide()},showDialog:function(B){$("#pro-roll-message").html("");$("#pro-roll-list").html("");$("#pro-roll-page").hide();var A=ec.shoppingCart.coupon.sbomCouponList[B];if(A){ec.shoppingCart.coupon.showDialogEx(B,A)}else{ec.shoppingCart.coupon.loadCouponEx(B,function(C){if(C&&C.success&&C.couponList&&C.couponList.length>0){ec.shoppingCart.coupon.sbomCouponList[B]=C.couponList;ec.shoppingCart.coupon.showDialogEx(B,C.couponList)}else{}},function(){},function(){})}},showDialogEx:function(B,A){couponBox=new ec.box($("#pro-roll-page").val(),{boxid:"order-edit-validate",boxclass:"ol_box_4",title:"- 领取优惠券 -",width:700,showButton:false,onopen:function(E){var G=A;var C=[];for(var D=0;D<G.length;D++){paramsReceiveCoupon="'"+G[D].activityCode+"','"+G[D].batchCode+"','"+B+"'";var F=G[D].activityCode+"-"+G[D].batchCode;var H="";switch(G[D].state){case -1:C.push('<li id="roll-detail-'+F+'" class="roll-detail receive" title="'+G[D].batchName+'">');C.push(' <a id="roll-link-'+F+'" href="javascript:;" > <em>¥</em>');H="已<br>领<br>完";break;case 1:C.push('<li id="roll-detail-'+F+'" class="roll-detail" title="'+G[D].batchName+'">');C.push(' <a id="roll-link-'+F+'" href="javascript:;"  onclick="ec.shoppingCart.coupon.receiveCoupon('+paramsReceiveCoupon+')"> <em>¥</em>');H="立<br>即<br>领<br>取";break;case 2:C.push('<li id="roll-detail-'+F+'" class="roll-detail receive" title="'+G[D].batchName+'">');C.push(' <a id="roll-link-'+F+'" href="javascript:;" > <em>¥</em>');H="已<br>领<br>取";break;case 3:C.push('<li id="roll-detail-'+F+'" class="roll-detail begin" title="'+G[D].batchName+'">');C.push(' <a id="roll-link-'+F+'" href="javascript:;" > <em>¥</em>');H="即<br>将<br>开<br>始";break;case 4:C.push('<li id="roll-detail-'+F+'" class="roll-detail disabled" title="'+G[D].batchName+'">');C.push(' <a id="roll-link-'+F+'" href="javascript:;" > <em>¥</em>');H="已<br>结<br>束";break;default:C.push('<li id="roll-detail-'+F+'" class="roll-detail" title="'+G[D].batchName+'">');C.push(' <a id="roll-link-'+F+'" href="javascript:;" > <em>¥</em>');H="";break}C.push(' <div class="roll-info">');C.push('  <div class="roll-price clearfix">');C.push("    <span>"+G[D].amount+"</span>");C.push("    <p><strong>优惠券</strong></p>");C.push("  </div>");C.push(' <p class="roll-word">'+G[D].batchName+"</p>");C.push(' <p class="roll-time">'+new Date(G[D].beginDate).format("yyyy-MM-dd")+" 至 "+new Date(G[D].endDate).format("yyyy-MM-dd")+"</p>");C.push("</div>");C.push('<div id="roll-state-'+F+'" class="roll-btn">'+H+"</div>");C.push("</a></li>")}var C='<ul class="clearfix">'+C.join(" ")+"</ul>";$("#pro-roll-list").html(C);E.setPosition()},onclose:function(C){}}).open()},filter:function(F){var E={},D=[];for(var B=0;B<F.length;B++){var C=F[B].activityCode;var A=F[B].batchCode;var G=C+"_"+A;if(E[G]){continue}E[G]=true;D.push(F[B])}return D},goLogin:function(){var A=domainMain+"/account/login?url="+encodeURIComponent(window.location.href)+"&_t="+new Date().getTime();window.location.href=A},showMsg:function(C,B){B=""+B;var A="";A="<span>"+C+"</span>";switch(B){case"9206":A+='<a href="javascript:;" onclick="ec.shoppingCart.coupon.goLogin()" >马上登录</a>';break;case"9208":A+='<a href="'+accountCenterUrl+'" target="_blank" >去绑定</a>';break;case"9209":A+='<a href="'+authUrl+'" target="_blank" >去认证</a>';break;case"9210":A+='<a href="'+accountCenterUrl+'" target="_blank" >完善资料</a>';break;default:A+=""}$("#pro-roll-message").html(A);$("#pro-roll-message").addClass("product-layer-tips")},receiveCoupon:function(B,D,E){var A=B+"_"+D;var C=B+"-"+D;ec.account.syncCustomSession(null);$("#pro-roll-message").html("");$("#pro-roll-message").removeClass();$.ajax({url:domainAms+"/couponCodeActivity/receive.json?activityCode="+B+"&batchCode="+D+"&t="+new Date().getTime(),dataType:"jsonp",timeout:10000,success:function(F){if(F&&F.state){switch(F.state){case -1:$("#roll-detail-"+C).addClass("receive");$("#roll-state-"+C).html("已<br>领<br>完");$("#roll-link-"+C).removeAttr("onclick");break;case 1:break;case 2:$("#roll-detail-"+C).addClass("receive");$("#roll-state-"+C).html("已<br>领<br>取");$("#roll-link-"+C).removeAttr("onclick");break;case 3:$("#roll-detail-"+C).addClass("begin");$("#roll-state-"+C).html("即<br>将<br>开<br>始");$("#roll-link-"+C).removeAttr("onclick");break;case 4:$("#roll-detail-"+C).addClass("disabled");$("#roll-state-"+C).html("已<br>结<br>束");$("#roll-link-"+C).removeAttr("onclick");break;default:break}}if(F&&F.success){$("#pro-roll-message").html("<span>"+F.pcReviceSuccTip+"</span>");$("#pro-roll-message").addClass("product-layer-tips product-layer-success");delete ec.shoppingCart.coupon.sbomCouponList[E];return}if(!F.code){$("#pro-roll-message").addClass("product-layer-tips");$("#pro-roll-message").html("<span>亲，瞬间被你的热情吓到了，容我缓缓，请稍候再来哦~</span>");return}ec.shoppingCart.coupon.showMsg(F.errorTip,F.code)},error:function(){$("#pro-roll-message").addClass("product-layer-tips");$("#pro-roll-message").html("<span>亲，瞬间被你的热情吓到了，容我缓缓，请稍候再来哦~</span>")}})},hideCoupon:function(){$("#whole-prompt-coupon").hide();ec.shoppingCart.coupon.sbomCouponList={}}};